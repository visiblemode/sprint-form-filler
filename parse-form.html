<!DOCTYPE html>
<html>
<head>
    <title>Google Forms Entry ID Extractor</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>Step 1: Fill Sleep Sprint Form Link</h1>
    <!-- Prefilled with your existing value -->
    <textarea id="htmlInput4" rows="1" cols="100">https://docs.google.com/forms/d/e/1FAIpQLSfgDq6VMxEZ-asWgDp8zF3ahhh1LR4aIoLHUre0VM6eJDf_hA/viewform</textarea>
    <br><br>

    <h1>Step 2: Google Forms Entry ID Extractor</h1>
    You need to copy and paste the source code of the Google Form into this box.<p>
    Page link: <a id="formLink" href="https://docs.google.com/forms/d/e/1FAIpQLSfgDq6VMxEZ-asWgDp8zF3ahhh1LR4aIoLHUre0VM6eJDf_hA/viewform" target="_blank">https://docs.google.com/forms/d/e/1FAIpQLSfgDq6VMxEZ-asWgDp8zF3ahhh1LR4aIoLHUre0VM6eJDf_hA/viewform</a>
    <br><br>

    <textarea id="htmlInput1" placeholder="Paste the Google Forms HTML here..." rows="5" cols="60"></textarea>
    <br><br>

    <h1>Step 3: Pok√©mon Sleep Data Extractor</h1>
    You need to copy and paste the source code of the Serebii "Available Pokemon" page into this box.<p>
    Page link: <a href="https://www.serebii.net/pokemonsleep/pokemon.shtml" target="_blank">https://www.serebii.net/pokemonsleep/pokemon.shtml</a>
    <br><br>

    <textarea id="htmlInput2" rows="5" cols="60" placeholder="Paste Serebii HTML content here..."></textarea>
    <br><br>
    <h1>Step 4: Pokemon Ordering (optional)</h1>
    This just changes the Pokemon order of the Palette (not within the tiers if they're already set). I just set it to the sprint list as a good default.<p> 
    <textarea id="htmlInput3" rows="10" cols="60" placeholder="Mudkip
Treecko
Larvitar
Chansey
Dratini
Wooper
Grubbin
Shinx
Aron
Bulbasaur
Squirtle
Farfetch'd
Dedenne
Torchic
Fuecoco
Snover
Sneasel
Cyndaquil
Stufful
Sprigatito
Cramorant
Bellsprout
Charmander
Quaxly
Chikorita
Totodile
Magnemite
Mimikyu
Pawmi
Mareep
Vulpix
Spheal
Plusle
Minun
Eevee
Pikachu" value="Mudkip
Treecko
Larvitar
Chansey
Dratini
Wooper
Grubbin
Shinx
Aron
Bulbasaur
Squirtle
Farfetch'd
Dedenne
Torchic
Fuecoco
Snover
Sneasel
Cyndaquil
Stufful
Sprigatito
Cramorant
Bellsprout
Charmander
Quaxly
Chikorita
Totodile
Magnemite
Mimikyu
Pawmi
Mareep
Vulpix
Spheal
Plusle
Minun
Eevee
Pikachu"></textarea>
    <br><br>

    <h1>Step 5: Extract Data and Generate Page</h1>
    <button onclick="extractData()">Click</button>

    <div id="resultArea" style="display: none;">
        <br>
        <h2>Generated URL:</h2>
        <textarea id="urlOutput" rows="3" cols="100" readonly></textarea>

    <h1>Step 6: Shorten URL</h1>
        <button onclick="shortenUrl()">Shorten with is.gd</button>

        <div id="shortUrlArea" style="display: none;">
            <br>
            <h3>Shortened URL:</h3>
            <textarea id="shortUrlOutput" rows="2" cols="100" readonly></textarea>
            <br><br>
            <button onclick="copyShortUrl()">Copy Short URL</button>
        </div>
    </div>

    <br><br>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script>
        // NEW: Update the Step 2 link dynamically
        const formTextarea = document.getElementById('htmlInput4');
        const formLink = document.getElementById('formLink');
        formTextarea.addEventListener('input', () => {
            const url = formTextarea.value.trim();
            if (url) {
                formLink.href = url;
                formLink.textContent = url;
            }
        });

        function copyTextToClipboard(text) {
            if (!text) return Promise.reject(new Error('Nothing to copy'));
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
            }
            // Fallback
            const t = document.createElement('textarea');
            t.value = text;
            document.body.appendChild(t);
            t.select();
            try {
                document.execCommand('copy');
                document.body.removeChild(t);
                return Promise.resolve();
            } catch (e) {
                document.body.removeChild(t);
                return Promise.reject(e);
            }
        }

        function extractEntryIdsData(htmlContent) {
            try {
                const scriptMatch = htmlContent.match(/var FB_PUBLIC_LOAD_DATA_ = (\[.*?\]);/s);
                if (!scriptMatch) {
                    console.error('Could not find FB_PUBLIC_LOAD_DATA_ in the HTML');
                    return null;
                }
                const formData = JSON.parse(scriptMatch[1]);
                const questions = formData[1][1];
                const entryIds = {};
                const pokemonNames = [];

                questions.forEach(question => {
                    const questionId = question[0];
                    const questionTitle = question[1];
                    const questionType = question[3];
                    const entries = question[4];

                    if (questionTitle && questionTitle.includes('TOP #')) {
                        const topNumber = questionTitle.match(/TOP #(\d+)/);
                        if (topNumber && entries && entries[0]) {
                            const entryId = entries[0][0];
                            entryIds['top' + topNumber[1]] = entryId;
                        }
                    } else if (questionType === 7 && entries && questionTitle && questionTitle.includes('importance')) {
                        entries.forEach(entry => {
                            const entryId = entry[0];
                            const pokemonName = entry[3] && entry[3][0];
                            if (pokemonName && entryId) {
                                entryIds[pokemonName] = entryId;
                                pokemonNames.push(pokemonName);
                            }
                        });
                    }
                });

                entryIds.pokemon = pokemonNames;
                return entryIds;
            } catch (error) {
                console.error('Error parsing HTML:', error);
                return null;
            }
        }

        function extractSerebii(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;

            const pokemonData = {};
            const rows = tempDiv.querySelectorAll('table.dextable tr');

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td');
                if (cells.length >= 2) {
                    const iconImg = cells[0].querySelector('img');
                    const nameLink = cells[1].querySelector('a u');
                    if (iconImg && nameLink) {
                        const iconPath = iconImg.getAttribute('src');
                        const pokemonName = nameLink.textContent.trim();
                        pokemonData[pokemonName] = iconPath;
                    }
                }
            }
            return pokemonData;
        }

        function extractData() {
            const googleFormHTML = document.getElementById('htmlInput1').value;
            const serebiiHTML = document.getElementById('htmlInput2').value;
            const orderingText = document.getElementById('htmlInput3').value.trim();
            const formURL = document.getElementById('htmlInput4').value.trim();

            if (!googleFormHTML.trim() || !serebiiHTML.trim() || !formURL.trim()) {
                alert('Please paste content in all required inputs');
                return null;
            }

            try {
                const entryIds = extractEntryIdsData(googleFormHTML);
                if (!entryIds) return null;

                const iconData = extractSerebii(serebiiHTML);

                const result = {
                    top1: entryIds.top1,
                    top2: entryIds.top2,
                    top3: entryIds.top3,
                    url: formURL,
                    pokemon: []
                };

                const formPokemon = new Set(entryIds.pokemon || []);
                let pokemonOrder = [];
                if (orderingText) {
                    pokemonOrder = orderingText.split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0 && formPokemon.has(line));
                }

                const uncoveredPokemon = Array.from(formPokemon)
                    .filter(name => !pokemonOrder.includes(name))
                    .sort();

                const finalOrder = [...pokemonOrder, ...uncoveredPokemon];

                finalOrder.forEach(pokemonName => {
                    const entryId = entryIds[pokemonName];
                    const iconPath = iconData[pokemonName];
                    if (entryId) {
                        if (iconPath) {
                            const filename = iconPath.split('/').pop();
                            result.pokemon.push([pokemonName, entryId, filename]);
                        } else {
                            console.warn('No icon found for ' + pokemonName);
                            result.pokemon.push([pokemonName, entryId, null]);
                        }
                    }
                });

                const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(result));
                const generatedUrl = `https://visiblemode.github.io/sprint-form-filler/#data=${compressed}`;

                document.getElementById('resultArea').style.display = 'block';
                document.getElementById('urlOutput').value = generatedUrl;
                document.getElementById('shortUrlArea').style.display = 'none';

                if (navigator.clipboard) {
                    navigator.clipboard.writeText(JSON.stringify(result, null, 2)).catch(() => {});
                }

                return result;
            } catch (error) {
                console.error('Error extracting data:', error);
                return null;
            }
        }

        function copyToClipboard() {
            const urlOutput = document.getElementById('urlOutput');
            urlOutput.select();
            urlOutput.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(urlOutput.value).then(() => {
                alert('URL copied to clipboard!');
            }).catch(() => {
                document.execCommand('copy');
                alert('URL copied to clipboard!');
            });
        }

        function copyShortUrl() {
            const shortUrlOutput = document.getElementById('shortUrlOutput');
            shortUrlOutput.select();
            shortUrlOutput.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(shortUrlOutput.value).then(() => {
                alert('Short URL copied to clipboard!');
            }).catch(() => {
                document.execCommand('copy');
                alert('Short URL copied to clipboard!');
            });
        }

        function shortenUrl() {
            const longUrl = document.getElementById('urlOutput').value;
            if (!longUrl) {
                alert('No URL to shorten!');
                return;
            }
            const shortenButton = event.target;
            shortenButton.textContent = 'Shortening...';
            shortenButton.disabled = true;

            const callbackName = 'shortenCallback_' + Date.now();
            window[callbackName] = function(data) {
                try {
                    if (data.shorturl) {
                        document.getElementById('shortUrlArea').style.display = 'block';
                        document.getElementById('shortUrlOutput').value = data.shorturl;
                    } else if (data.errormessage) {
                        throw new Error(data.errormessage);
                    } else {
                        throw new Error('Unknown error from is.gd');
                    }
                } catch (error) {
                    alert('Failed to shorten URL: ' + error.message);
                } finally {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    shortenButton.textContent = 'Shorten with is.gd';
                    shortenButton.disabled = false;
                }
            };

            const script = document.createElement('script');
            script.src = 'https://is.gd/create.php?format=json&callback=' + callbackName + '&url=' + encodeURIComponent(longUrl);
            script.onerror = function() {
                alert('Failed to connect to is.gd. Please check your internet connection.');
                document.head.removeChild(script);
                delete window[callbackName];
                shortenButton.textContent = 'Shorten with is.gd';
                shortenButton.disabled = false;
            };
            document.head.appendChild(script);
        }
    </script>
</body>
</html>
